#include<stdio.h>
#include<stdlib.h>
#include"includes.h"

/**
 *cette fonction retourne un pointeur (*espaceMemoireDebut)
 * de type void sur l'espace memoire de travail interne
 */

int initMemory(int nBytes){
	if(espaceMemoireDebut=malloc(nBytes/8)){
		espaceMemoireFin = espaceMemoireDebut + nBytes/8;
		taille = nBytes/8;
		return nBytes;	
	}
	else{
		return 0;		
	}
}

/**
 *cette fonction libere l'espace memoire de travaille interne et retourne
 *la taille initialement alloué
 */
int freeMemory(){
	if(espaceMemoireDebut){
		free(espaceMemoireDebut);
		return taille;	
	}
	else{
		return -1;	
	}
}

/**
 *cette fonction alloue de la memoire sur notre zone de memoire interne
 */
void *myalloc(int nBytes){
	/**On verifie si aucune allocation n'a été faite.
	 *si OUI on fait la premiere allocation
	 */
	if (listeAllocations == NULL){
		listeAllocations = malloc(sizeof(listeAllocation));
		listeAllocations->taille = nBytes/8; /*taille en octet*/
		listeAllocations->debutAlloc = espaceMemoireDebut;
		listeAllocations->finAlloc = listeAllocations->debutAlloc + nBytes/8;
		listeAllocations->allocSuivant = NULL;
		printf("---------Allocation de %d bits-------------\n",nBytes);
		printf("Zone allouée : %p jusqu'a %p\n",listeAllocations->debutAlloc,listeAllocations->finAlloc);
		return listeAllocations->debutAlloc;	 	
	}
	else{
		listeAllocation *copieListe = listeAllocations;
		while(copieListe->allocSuivant!=NULL){
			copieListe = copieListe->allocSuivant;	
		}
		listeAllocation *newAlloc = malloc(sizeof(listeAllocation));		
		newAlloc->taille = nBytes/8; //taille en octet
		newAlloc->debutAlloc = copieListe->finAlloc+1;
		newAlloc->finAlloc = newAlloc->debutAlloc + nBytes/8;
		newAlloc->allocSuivant = NULL;
		if(newAlloc->debutAlloc < espaceMemoireFin && newAlloc->finAlloc <espaceMemoireFin){
			copieListe->allocSuivant = newAlloc;
			printf("---------Allocation de %d bits-------------\n",nBytes);
			printf("Zone allouée : %p jusqu'a %p\n",
			newAlloc->debutAlloc,newAlloc->finAlloc);
			return newAlloc->debutAlloc;
		}
		else{
			printf("Allocation impossible......\n");
			return NULL;		
		}			
	}	
}
/**
 *cette fonction permet de liberer une allocation faite dans notre zone de memoire
 */
int myfree(void *p){
	if(p == NULL){
		return -1;	
	}
	else{
		listeAllocation *copieListe = listeAllocations;
		listeAllocation *cache;
		int tailleLiberer=0;
		if(copieListe->debutAlloc == p){
			listeAllocations = copieListe->allocSuivant;
			tailleLiberer = copieListe->taille * 8;
			free(copieListe);
			return tailleLiberer;			
		}
		else{
			while(copieListe!=NULL){
				if(copieListe->allocSuivant->debutAlloc != p){
					copieListe = copieListe->allocSuivant;
				}
				else{
					cache = copieListe->allocSuivant;
					copieListe->allocSuivant= copieListe->allocSuivant->allocSuivant;
					tailleLiberer = cache->taille * 8;
					free(cache);
					return tailleLiberer;
									
				}		
			}	
		}
	}
}
